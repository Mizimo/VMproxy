#!/bin/bash
# macproxy for macOS
# Version 2026.02
# 讓 macOS 一鍵切換 HTTP/HTTPS/SOCKS 代理
# Author: 藥アイ & ChatGPT & Claude

CONFIG_FILE="$HOME/.macproxy.conf"
PROFILE_FILE="$HOME/.macproxy_env"
GREEN='\033[0;32m'; YELLOW='\033[1;33m'; RED='\033[0;31m'; CYAN='\033[0;36m'; NC='\033[0m'

# --- 載入/初始化設定 ---
function load_config() {
    if [[ -f "$CONFIG_FILE" ]]; then
        source "$CONFIG_FILE"
    fi
    PROXY_HOST="${PROXY_HOST:-192.168.1.1}"
    PROXY_PORT="${PROXY_PORT:-7890}"
    PROXY_URL="http://${PROXY_HOST}:${PROXY_PORT}"
}

function save_config() {
    cat > "$CONFIG_FILE" <<EOF
PROXY_HOST="$PROXY_HOST"
PROXY_PORT="$PROXY_PORT"
EOF
}

# --- 自動偵測活躍網路介面 ---
function detect_services() {
    local services=()
    while IFS= read -r svc; do
        [[ "$svc" == *"*"* ]] && continue  # 跳過已停用的介面
        [[ -z "$svc" ]] && continue
        # 檢查介面是否有 IP 位址（即活躍）
        local ip
        ip=$(networksetup -getinfo "$svc" 2>/dev/null | grep "^IP address:" | awk '{print $3}')
        if [[ -n "$ip" && "$ip" != "none" ]]; then
            services+=("$svc")
        fi
    done < <(networksetup -listallnetworkservices 2>/dev/null | tail -n +2)

    if [[ ${#services[@]} -eq 0 ]]; then
        echo -e "${RED}[錯誤] 未找到活躍的網路介面${NC}" >&2
        return 1
    fi
    printf '%s\n' "${services[@]}"
}

# --- 啟用代理 ---
function enable_proxy() {
    load_config
    local services
    services=$(detect_services) || return 1

    echo -e "${GREEN}→ 啟用系統代理: ${PROXY_URL}${NC}"
    while IFS= read -r svc; do
        echo -e "  ${CYAN}[$svc]${NC}"
        networksetup -setwebproxy "$svc" "$PROXY_HOST" "$PROXY_PORT"
        networksetup -setsecurewebproxy "$svc" "$PROXY_HOST" "$PROXY_PORT"
        networksetup -setsocksfirewallproxy "$svc" "$PROXY_HOST" "$PROXY_PORT"
        networksetup -setwebproxystate "$svc" on
        networksetup -setsecurewebproxystate "$svc" on
        networksetup -setsocksfirewallproxystate "$svc" on
    done <<< "$services"

    cat > "$PROFILE_FILE" <<EOF
export http_proxy=$PROXY_URL
export https_proxy=$PROXY_URL
export all_proxy=socks5://${PROXY_HOST}:${PROXY_PORT}
EOF
    echo -e "${GREEN}[OK] 系統代理已啟用${NC}"
    echo -e "  提示: 執行 ${CYAN}source ~/.macproxy_env${NC} 使當前終端生效"
}

# --- 關閉代理 ---
function disable_proxy() {
    local services
    services=$(detect_services) || return 1

    echo -e "${YELLOW}→ 關閉系統代理${NC}"
    while IFS= read -r svc; do
        echo -e "  ${CYAN}[$svc]${NC}"
        networksetup -setwebproxystate "$svc" off
        networksetup -setsecurewebproxystate "$svc" off
        networksetup -setsocksfirewallproxystate "$svc" off
    done <<< "$services"

    rm -f "$PROFILE_FILE"
    echo -e "${YELLOW}[OK] 系統代理已關閉${NC}"
    echo -e "  提示: 執行 ${CYAN}unset http_proxy https_proxy all_proxy${NC} 清除當前終端變數"
}

# --- 查看狀態 ---
function show_status() {
    load_config
    local services
    services=$(detect_services) || return 1

    echo "---- macproxy 狀態 ----"
    echo -e "設定: ${CYAN}${PROXY_HOST}:${PROXY_PORT}${NC}"
    echo ""
    while IFS= read -r svc; do
        echo -e "  ${CYAN}[$svc]${NC}"
        local http_state https_state socks_state
        http_state=$(networksetup -getwebproxy "$svc" 2>/dev/null | grep "^Enabled:" | awk '{print $2}')
        https_state=$(networksetup -getsecurewebproxy "$svc" 2>/dev/null | grep "^Enabled:" | awk '{print $2}')
        socks_state=$(networksetup -getsocksfirewallproxy "$svc" 2>/dev/null | grep "^Enabled:" | awk '{print $2}')
        printf "    HTTP: %-5s  HTTPS: %-5s  SOCKS: %-5s\n" "$http_state" "$https_state" "$socks_state"
    done <<< "$services"

    echo ""
    if [[ -n "${http_proxy:-}" ]]; then
        echo -e "  [ENV] http_proxy=${http_proxy}"
        echo -e "  [ENV] https_proxy=${https_proxy:-未設定}"
        echo -e "  [ENV] all_proxy=${all_proxy:-未設定}"
    else
        echo -e "  [ENV] ${RED}環境變數未設定${NC}"
    fi
    echo "------------------------"
}

# --- 設定代理位址 ---
function config_proxy() {
    load_config
    if [[ -z "$2" ]]; then
        echo "---- macproxy 當前設定 ----"
        echo -e "  位址: ${CYAN}${PROXY_HOST}${NC}"
        echo -e "  連接埠: ${CYAN}${PROXY_PORT}${NC}"
        echo ""
        echo "用法:"
        echo "  macproxy config <host> [port]    設定代理位址與連接埠"
        echo "  macproxy config <host>:<port>    設定代理位址與連接埠"
        echo ""
        echo "範例:"
        echo "  macproxy config 192.168.1.100 7890"
        echo "  macproxy config 192.168.1.100:1080"
        return
    fi

    local input="$2"
    local new_port="${3:-}"

    # 支援 host:port 格式
    if [[ "$input" == *":"* && -z "$new_port" ]]; then
        PROXY_HOST="${input%%:*}"
        PROXY_PORT="${input##*:}"
    else
        PROXY_HOST="$input"
        [[ -n "$new_port" ]] && PROXY_PORT="$new_port"
    fi

    save_config
    echo -e "${GREEN}[OK] 設定已儲存${NC}"
    echo -e "  位址: ${CYAN}${PROXY_HOST}${NC}"
    echo -e "  連接埠: ${CYAN}${PROXY_PORT}${NC}"
    echo -e "  提示: 執行 ${CYAN}macproxy on${NC} 使新設定生效"
}

# --- 初始化 shell 自動載入 ---
SHELL_HOOK='# macproxy 環境變數自動載入
[[ -f ~/.macproxy_env ]] && source ~/.macproxy_env'

function detect_rc_file() {
    case "$(basename "$SHELL")" in
        zsh)  echo "$HOME/.zshrc" ;;
        bash) echo "$HOME/.bashrc" ;;
        *)    echo "$HOME/.profile" ;;
    esac
}

function init_shell() {
    local rc_file
    rc_file=$(detect_rc_file)

    if grep -qF 'macproxy_env' "$rc_file" 2>/dev/null; then
        echo -e "${YELLOW}[略過] ${rc_file} 中已存在 macproxy 設定${NC}"
        return
    fi

    echo "" >> "$rc_file"
    echo "$SHELL_HOOK" >> "$rc_file"
    echo -e "${GREEN}[OK] 已寫入 ${rc_file}${NC}"
    echo -e "  新開的終端視窗將自動載入代理環境變數"
}

function uninit_shell() {
    local rc_file
    rc_file=$(detect_rc_file)

    if ! grep -qF 'macproxy_env' "$rc_file" 2>/dev/null; then
        echo -e "${YELLOW}[略過] ${rc_file} 中未找到 macproxy 設定${NC}"
        return
    fi

    # 移除 macproxy 相關行
    sed -i '' '/# macproxy 環境變數自動載入/d;/macproxy_env/d' "$rc_file"
    # 清除可能殘留的末尾空行
    sed -i '' -e :a -e '/^\n*$/{$d;N;ba' -e '}' "$rc_file"
    echo -e "${GREEN}[OK] 已從 ${rc_file} 移除 macproxy 設定${NC}"
}

# --- 主入口 ---
case "$1" in
    on)     enable_proxy ;;
    off)    disable_proxy ;;
    status) show_status ;;
    config) config_proxy "$@" ;;
    init)   init_shell ;;
    uninit) uninit_shell ;;
    *)
        echo "macproxy - macOS 代理管理工具 (v2026.02)"
        echo ""
        echo "用法: macproxy <指令>"
        echo ""
        echo "指令:"
        echo "  on                   啟用系統代理"
        echo "  off                  關閉系統代理"
        echo "  status               查看代理狀態"
        echo "  config [host] [port] 查看/設定代理位址"
        echo "  init                 將自動載入寫入 shell 設定檔"
        echo "  uninit               從 shell 設定檔移除自動載入"
        ;;
esac
